name: Continuous Deployment

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: dedukr
  BACKEND_IMAGE: landar-backend
  FRONTEND_IMAGE: landar-frontend-marketplace
  NGINX_IMAGE: landar-nginx
  POSTGRES_IMAGE: landar-postgres

jobs:
  security-check:
    name: Security Check
    uses: ./.github/workflows/security-scan.yml
    if: ${{ !inputs.skip-tests }}
    with:
      fail-on-critical: true
      upload-sarif: true

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: security-check
    if: always() && (needs.security-check.result == 'success' || inputs.skip-tests)
    
    strategy:
      matrix:
        include:
          - service: backend
            image: landar-backend
            context: ./backend
          - service: frontend-marketplace
            image: landar-frontend-marketplace
            context: ./frontend-marketplace
          - service: nginx
            image: landar-nginx
            context: ./nginx
          - service: postgres
            image: landar-postgres
            context: ./postgresql
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: ./.github/actions/docker-build-push
        with:
          service-name: ${{ matrix.service }}
          image-name: ${{ env.REGISTRY }}/${{ matrix.image }}
          context-path: ${{ matrix.context }}
          push: 'true'
          platforms: 'linux/amd64,linux/arm64'

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ matrix.image }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  pre-deployment-backup:
    name: Pre-Deployment Backup
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create pre-deployment backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # Load environment variables (including AWS credentials)
            if [ -f ".env" ]; then
              export $(grep -v '^#' .env | xargs)
            fi

            echo "üóÑÔ∏è Creating pre-deployment backup..."
            chmod +x management/pg_backup.sh
            
            # Verify AWS CLI is available (for S3 uploads)
            if command -v aws &> /dev/null; then
              echo "‚úÖ AWS CLI is available"
              if [[ -n "$AWS_STORAGE_BUCKET_NAME" ]]; then
                echo "‚òÅÔ∏è  S3 backup enabled to: $AWS_STORAGE_BUCKET_NAME"
              fi
            else
              echo "‚ö†Ô∏è  AWS CLI not found - S3 backup will be skipped"
            fi

            if ./management/pg_backup.sh backup; then
              echo "‚úÖ Pre-deployment backup completed"
              
              # Store backup timestamp for rollback reference
              BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
              echo "$BACKUP_TIME" > /tmp/pre_deployment_backup_timestamp
              echo "BACKUP_TIMESTAMP=$BACKUP_TIME" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Pre-deployment backup failed"
              exit 1
            fi

      - name: Store current deployment SHA
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # Store current git SHA for rollback
            CURRENT_SHA=$(git rev-parse HEAD)
            echo "$CURRENT_SHA" > /tmp/previous_deployment_sha
            echo "Previous deployment SHA: $CURRENT_SHA"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-backup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            
            PROJECT_DIR="${{ secrets.PROJECT_PATH }}"
            cd "$PROJECT_DIR"
            
            echo "üöÄ Starting deployment..."
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin main || git pull origin master
            
            # Pull latest Docker images
            echo "üì• Pulling latest Docker images..."
            docker compose pull
            
            # Stop containers gracefully
            echo "üõë Stopping containers..."
            docker compose down --timeout 30 || docker compose down --timeout 10
            
            # Start new containers
            echo "‚ñ∂Ô∏è  Starting new containers..."
            docker compose up -d
            
            echo "‚úÖ Deployment completed"

  health-check:
    name: Health Check & Post-Deploy
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for services to start
        run: |
          echo "‚è≥ Waiting for services to initialize..."
          sleep 30

      - name: Run health checks
        id: health-check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # Source environment variables
            if [ -f ".env" ]; then
              export $(grep -v '^#' .env | xargs)
            fi
            
            echo "üè• Running health checks..."
            
            # Check PostgreSQL
            if docker compose exec -T postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}; then
              echo "‚úÖ PostgreSQL is healthy"
            else
              echo "‚ùå PostgreSQL health check failed"
              exit 1
            fi
            
            # Check Backend
            MAX_RETRIES=10
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:8000/health/ > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                  echo "‚ùå Backend health check failed after $MAX_RETRIES attempts"
                  exit 1
                fi
                echo "‚è≥ Waiting for backend... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep 5
              fi
            done
            
            # Check Frontend
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Frontend is healthy"
            else
              echo "‚ùå Frontend health check failed"
              exit 1
            fi
            
            # Check Nginx
            if curl -f http://localhost:80 > /dev/null 2>&1; then
              echo "‚úÖ Nginx is healthy"
            else
              echo "‚ùå Nginx health check failed"
              exit 1
            fi
            
            echo "‚úÖ All health checks passed!"

      - name: Run database migrations
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "üîÑ Running database migrations..."
            docker compose exec -T backend python manage.py migrate --noinput
            
            echo "üì¶ Collecting static files..."
            docker compose exec -T backend python manage.py collectstatic --noinput

      - name: Create post-deployment backup
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "üóÑÔ∏è Creating post-deployment backup..."
            if ./management/pg_backup.sh backup; then
              echo "‚úÖ Post-deployment backup completed"
            else
              echo "‚ö†Ô∏è Post-deployment backup failed (non-critical)"
            fi

  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "üîÑ ROLLBACK INITIATED - Deployment failed health checks"
            
            # Source environment variables
            if [ -f ".env" ]; then
              export $(grep -v '^#' .env | xargs)
            fi
            
            # Stop failed containers
            echo "üõë Stopping failed containers..."
            docker compose down --timeout 30
            
            # Restore previous git state
            if [ -f "/tmp/previous_deployment_sha" ]; then
              PREVIOUS_SHA=$(cat /tmp/previous_deployment_sha)
              echo "‚è™ Rolling back to SHA: $PREVIOUS_SHA"
              git reset --hard $PREVIOUS_SHA
            fi
            
            # Restore database from pre-deployment backup
            echo "üóÑÔ∏è Restoring database from backup..."
            LATEST_BACKUP=$(ls -t db_backups/ | head -n1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Restoring from: $LATEST_BACKUP"
              
              # Start only postgres to restore
              docker compose up -d postgres
              sleep 10
              
              # Drop and recreate database
              docker compose exec -T postgres psql -U ${POSTGRES_USER} -d postgres -c "DROP DATABASE IF EXISTS ${POSTGRES_DB};"
              docker compose exec -T postgres psql -U ${POSTGRES_USER} -d postgres -c "CREATE DATABASE ${POSTGRES_DB};"
              
              # Restore backup
              if [ -f "db_backups/$LATEST_BACKUP/postgres_backup.sql.gz" ]; then
                zcat "db_backups/$LATEST_BACKUP/postgres_backup.sql.gz" | docker compose exec -T postgres psql -U ${POSTGRES_USER} -d ${POSTGRES_DB}
                echo "‚úÖ Database restored"
              fi
            fi
            
            # Pull previous images and restart
            echo "üì• Pulling previous images..."
            docker compose pull
            
            echo "‚ñ∂Ô∏è  Starting previous version..."
            docker compose up -d
            
            # Wait and verify
            sleep 20
            
            # Re-run health checks
            echo "üè• Verifying rollback..."
            if curl -f http://localhost:8000/health/ > /dev/null 2>&1 && \
               curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Rollback successful - Previous version restored"
            else
              echo "‚ùå Rollback verification failed - Manual intervention required"
              exit 1
            fi

      - name: Notify rollback
        if: always()
        run: |
          echo "## ‚ö†Ô∏è AUTOMATIC ROLLBACK EXECUTED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed health checks and was automatically rolled back." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Review the deployment logs and fix issues before redeploying." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rollback completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: health-check
    if: success()
    
    steps:
      - name: Cleanup Docker resources
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "üßπ Cleaning up old Docker resources..."
            docker image prune -f --filter "until=168h"
            docker volume prune -f
            echo "‚úÖ Cleanup completed"

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [security-check, build-and-push, pre-deployment-backup, deploy, health-check, cleanup]
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "## üöÄ Deployment Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-check.result }}" == "success" ] || [ "${{ needs.security-check.result }}" == "skipped" ]; then
            echo "‚úÖ Security Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Security Check: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "‚úÖ Build & Push: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Build & Push: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.pre-deployment-backup.result }}" == "success" ]; then
            echo "‚úÖ Pre-Deployment Backup: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Pre-Deployment Backup: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Deployment: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "‚úÖ Health Checks: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Health Checks: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cleanup.result }}" == "success" ]; then
            echo "‚úÖ Cleanup: Completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Check overall deployment status
        if: needs.deploy.result != 'success' || needs.health-check.result != 'success'
        run: |
          echo "‚ùå Deployment failed. System has been rolled back."
          exit 1
