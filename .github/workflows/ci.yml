name: Continuous Integration

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Backend Environment
        uses: ./.github/actions/setup-backend
        with:
          python-version: '3.12'

      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend
        with:
          node-version: '20'

      - name: Lint Backend (flake8)
        working-directory: ./backend
        run: |
          echo "üîç Running Python linting..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Lint Backend (black)
        working-directory: ./backend
        run: |
          echo "üîç Checking Python code formatting..."
          black --check . || echo "‚ö†Ô∏è Code formatting issues found"

      - name: Lint Frontend (ESLint)
        working-directory: ./frontend-marketplace
        run: |
          echo "üîç Running ESLint..."
          npm run lint

      - name: TypeScript Type Check
        working-directory: ./frontend-marketplace
        run: |
          echo "üîç Checking TypeScript types..."
          npx tsc --noEmit

  security-scan:
    name: Security Scanning
    uses: ./.github/workflows/security-scan.yml
    with:
      fail-on-critical: true
      upload-sarif: true

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Backend Environment
        uses: ./.github/actions/setup-backend
        with:
          python-version: '3.12'

      - name: Run Django tests with coverage
        working-directory: ./backend
        env:
          DJANGO_SETTINGS_MODULE: backend.settings
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: 'True'
        run: |
          echo "üß™ Running Django tests..."
          coverage run --source='.' manage.py test --verbosity=2
          coverage xml
          coverage report

      - name: Check test coverage
        working-directory: ./backend
        run: |
          echo "üìä Checking coverage threshold..."
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "‚ùå Coverage ${COVERAGE}% is below 70% threshold"
            exit 1
          fi
          echo "‚úÖ Coverage ${COVERAGE}% meets threshold"

      - name: Upload backend coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend
        with:
          node-version: '20'

      - name: Run Jest tests with coverage
        working-directory: ./frontend-marketplace
        run: |
          echo "üß™ Running Jest tests..."
          npm run test:coverage -- --watchAll=false --passWithNoTests

      - name: Check test coverage
        working-directory: ./frontend-marketplace
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              const fs = require('fs');
              const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json'));
              summary.total.lines.pct;
            ")
            echo "Coverage: ${COVERAGE}%"
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "‚ùå Coverage ${COVERAGE}% is below 70% threshold"
              exit 1
            fi
            echo "‚úÖ Coverage ${COVERAGE}% meets threshold"
          else
            echo "‚ö†Ô∏è No coverage report found"
          fi

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./frontend-marketplace/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    strategy:
      matrix:
        service: [backend, frontend-marketplace]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: false
          load: true
          tags: ${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}-ci
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-ci

      - name: Test image startup
        run: |
          echo "üß™ Testing ${{ matrix.service }} container startup..."
          docker run --rm -d --name test-${{ matrix.service }} ${{ matrix.service }}:test
          sleep 10
          
          # Check if container is running
          if docker ps | grep -q test-${{ matrix.service }}; then
            echo "‚úÖ Container started successfully"
            docker stop test-${{ matrix.service }}
          else
            echo "‚ùå Container failed to start"
            docker logs test-${{ matrix.service }} || true
            exit 1
          fi

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, test-backend, test-frontend, build-test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## üéØ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "‚úÖ Code Quality: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Code Quality: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "‚úÖ Security Scan: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Security Scan: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-backend.result }}" == "success" ]; then
            echo "‚úÖ Backend Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Backend Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-frontend.result }}" == "success" ]; then
            echo "‚úÖ Frontend Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Frontend Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "‚úÖ Build Test: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Build Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: needs.code-quality.result != 'success' || needs.security-scan.result != 'success' || needs.test-backend.result != 'success' || needs.test-frontend.result != 'success' || needs.build-test.result != 'success'
        run: |
          echo "‚ùå CI pipeline failed. Please review the errors above."
          exit 1
